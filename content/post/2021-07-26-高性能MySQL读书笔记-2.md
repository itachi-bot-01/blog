---
title: 《高性能MySQL》读书笔记-2-Schema与数据类型优化
categories: [ Technology]
date: 2021-07-28T00:00:00+08:00
description: 《高性能MySQL》读书笔记-2-Schema与数据类型优化
tags: [高性能MySQL,读书笔记]
url: /post/high-performance-mysql-2.html
---



良好的额逻辑设计和屋里设计是高性能的基石，系统需根据要执行的拆线呢语句来设计schema，其中反范式的设计可以加快某些类型的查询，但是可以导致一些类型的查询变慢。

## 选择优化的数据类型  

选择合适数据类型的原则：
* 更小的通常更好

  一般情形下，尽量使用可以正确存储数据的最小数据类型，更小的数据类型占用更少的磁盘、内存、CPU缓存、更少的CPU周期。

* 简单就好

  简单数据类型的操作通常需要更少的CPU周期。整型比字符串操作代价更低，字符串的字符集和校对规则要比整型的复杂。例如：使用内建的类型来存储时间；使用整型来存储IP值。

* 尽量避免NULL

  通常情况最好指定列为not null，除非真的需要存储null值。可以为null的列使得索引、索引统计、值比较都变得更复杂。

timestamp和datetime都可以存储时间和日期，精确到秒：其中timestamp只需要datetime一般的空间，但是timestamp允许的时间范围小得多。

### 整数类型  

整数存储可以使用：tinyint,smallint,mediumint,int,bigint，他们分别使用8，16，24，32，64位存储空间。同时整数可选unsigned属性，表示正整数。这可以使得该类型的上限范围大概提高一倍。 整数计算一般使用64位的bigint整数。虽然MySQL可以为整数类型指定宽度，例如int(11),一般来说没有意义，他不会限制值的合法范围，只是规定了MySQL的交互工具显示字符的个数，对于存储和计算来说，int(1)和int(20)是相同的。  

### 实数类型  

实数是带有小数的数字。float(4字节)和double(8字节)类型支持标准的浮点数运算，同时decimal支持更高精度的计算。需要指出，由于CPU不支持decimal的直接计算，decimal类型的计算是由MySQL自己实现的。因此，如非必要，使用原生浮点计算类型float和double会比decimal更快。使用浮点数时，建议只指定数据类型，不指定精度，MySQL使用double作为内部浮点计算的类型。

由于浮点数计算需要额外的空间和计算开销，所以尽量只在对小数进行计算时才使用decimal。数据量比较大的情况下，可以根据小数位数乘以相应倍数，使用bigint来存储，可以避免浮点数计算不精确和decimal计算代价高的问题。  

### 字符串类型  

* varchar

  varchar用于存储可变长字符串。他会使用额外的1到2个字节来存储字符串长度。varchar节省了空间，对性能有帮助，但是变长也带来了一些问题：update时字符串可能变长，这就需要额外的工作，比如，InnoDB可能会需要分裂页来让行可以放进页内。  

  合适的用varchar情况：

  1. 字符串列的最大长度比平均值大的多，
  2. 列的更新少，碎片化不是问题；
  3. 使用了UTF-8这样复杂字符集的，每个字符都用不同的字节存储

* char

  char是定长的，MySQL会根据定义的长度分配足够的空间，存储char值时，MySQL会删除字符串末尾空格，同时根据需要填充空格以方便比较。

  适合char的情况：

  1. 短的字符串，或者所有值都接近一个长度
  2. 经常变更的数据，char也比varchar更好，char不容易产生碎片

  比较短的列，char比varchar在存储空间上更有效率，比如char(1)存储Y和N，如果采用单字符集只需要一个自己，而varchar(1)需要2个字节，一个存值一个存长度。

###   blob和text类型  

很大数据数据可以使用blob或者text类型，blob类型使用二进制存储，他没有排序规则或字符集，而text使用字符方式，需要字符集和排序规则。

* blob类型：tinyblob，smallblob，blob，mediumblob，longblob  
* text类型：tinytext，smalltext，text，mediumtext，longtext

MySQL把blob和text当作一个独立对象来存储，当值比较大时，InnoDB会使用外部区域来存储，同时每个值在行内需要1-4个字节存储一个指针，指向外部区域实际的值。  

MySQL对blob和text列的排序：它只对每个列的最前max_sort_length个字节做排序，如果只需要排序一小部分可以减少max_sort_length的值，或者使用order by sustring(cloumn,length)。同时MySQL不会对blob和text全部长度的字符串做索引，也不能使用这些索引消除排序。

> 如果Explain执行计划中的Extra列包含“Using temporary”,说明这个查询使用了隐式临时表

#### 使用枚举代替字符串  

枚举列可以把以一些不重复的字符串存储成一个预定义集合，MySQL会根据列表值的胡数量压缩到一个或者两个字节中，MySQL在内部会将值在列表中的位置保存为整数，在表的frm文件中保存"数字-字符串"映射关系的查找表：

```sql
mysql> create teable enum_test(
	->  e ENUM('fish','appale',"dog") NOT NULL
	->);
mysql> insert into enum_tes(e) values('fish','dog','appale');
```

实际存储的时整数，可以在数字上下文环境检索：

```sql
mysql> select e + 0 from enum_test;
+-----+
|e + 0|
|    1|
|    3|
|    2|
+-----+
```

同时，枚举字段是按照内部存的整数而不是定义的字符串来排序的

```sql
mysql> select e  from enum_test;
+-------+
| e     |
| fish  |
| appale|
| dog   |
+-------+
```

### 日期和时间类型  

（未完待续...）

## 微语录  

我之所谓生存，并不是苟活，所谓温饱，不是奢侈，所谓发展，也不是放纵。 -- 鲁迅